<!DOCTYPE html>
<html>
<head>
  <title>TradingView - Realtime</title>
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <h3>Realtime Candles from Bybit/BingX/HTX</h3>
  <div id="chart" style="width: 800px; height: 500px;"></div>

  <script>
    // Создаём график
    const chartElem = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartElem, { width: 800, height: 500 });
    const series = chart.addCandlestickSeries();
    let bars = [];  // массив всех баров

    // Подключаемся к SocketIO => namespace /live
    const socket = io("http://127.0.0.1:8000/live");

    socket.on('connect', () => {
      console.log("[frontend] connected to /live");
    });

    socket.on('new_candle', (rawMsg) => {
      // rawMsg => JSON
      const msg = JSON.parse(rawMsg);
      // msg = { source: "BYBIT_BTCUSDT", candle: {...} }
      const cndl = msg.candle;
      // cndl = { start, open, high, low, close, volume }

      // LightweightCharts требует time (в секундах), open/high/low/close
      let bar = {
        time: Math.floor(cndl.start), // или cndl.start/1e3
        open:  cndl.open,
        high:  cndl.high,
        low:   cndl.low,
        close: cndl.close
      };
      bars.push(bar);
      series.setData(bars);
    });
  </script>
</body>
</html>
